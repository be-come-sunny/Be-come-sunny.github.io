<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI钢琴瀑布流播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/midi-file@1.4.15/dist/midi-file.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.36/build/Tone.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .piano-key {
                transition: all 0.1s ease;
            }
            .note {
                position: absolute;
                border-radius: 2px;
                transition: transform 0.1s linear;
            }
            .track {
                position: relative;
                overflow: hidden;
            }
            .keyboard-container {
                touch-action: none;
            }
            .scroll-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-dark to-gray-800 text-light font-inter min-h-screen">
    <header class="bg-dark/80 backdrop-blur-md sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa fa-music text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">MIDI钢琴瀑布流</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <i class="fa fa-moon-o text-lg"></i>
                </button>
                <button id="info-button" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                    <i class="fa fa-info text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 文件上传区域 -->
        <section class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-xl mb-8 transition-all hover:shadow-2xl">
            <div class="text-center mb-6">
                <h2 class="text-2xl md:text-3xl font-bold mb-2">上传MIDI文件</h2>
                <p class="text-gray-400">选择一个MIDI文件(.mid)，将其转换为钢琴瀑布流进行播放</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-6 items-center justify-center">
                <div class="w-full md:w-1/2">
                    <label for="midi-upload" class="block cursor-pointer bg-gray-700/50 border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:bg-gray-700 transition-colors">
                        <i class="fa fa-cloud-upload text-4xl text-primary mb-4"></i>
                        <p class="text-lg font-medium">拖放MIDI文件到这里</p>
                        <p class="text-gray-400 mt-2">或者</p>
                        <p class="text-primary font-medium">点击选择文件</p>
                        <input id="midi-upload" type="file" accept=".mid" class="hidden" />
                    </label>
                </div>
                
                <div class="w-full md:w-1/2 bg-gray-700/30 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fa fa-file-text-o text-primary mr-2"></i>当前文件
                    </h3>
                    <div id="file-info" class="hidden">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center mr-4">
                                <i class="fa fa-music text-primary text-xl"></i>
                            </div>
                            <div>
                                <p id="file-name" class="font-medium">未选择文件</p>
                                <p id="file-size" class="text-sm text-gray-400">0 KB</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-400">音轨数量</p>
                                <p id="track-count" class="font-medium">0</p>
                            </div>
                            <div>
                                <p class="text-gray-400">时长</p>
                                <p id="duration" class="font-medium">00:00</p>
                            </div>
                        </div>
                    </div>
                    <div id="no-file-info" class="flex flex-col items-center justify-center h-32">
                        <i class="fa fa-file-o text-4xl text-gray-600 mb-2"></i>
                        <p class="text-gray-500">未选择文件</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 播放控制区域 -->
        <section class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-xl mb-8 transition-all hover:shadow-2xl">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <div class="flex items-center mb-4 md:mb-0">
                    <button id="play-btn" class="w-14 h-14 bg-primary rounded-full flex items-center justify-center shadow-lg hover:bg-primary/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa fa-play text-xl"></i>
                    </button>
                    <div class="ml-4">
                        <div class="flex items-center space-x-2">
                            <button id="rewind-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <i class="fa fa-step-backward"></i>
                            </button>
                            <button id="prev-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <i class="fa fa-backward"></i>
                            </button>
                            <button id="next-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <i class="fa fa-forward"></i>
                            </button>
                            <button id="fast-forward-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                                <i class="fa fa-step-forward"></i>
                            </button>
                        </div>
                        <div class="flex items-center mt-1">
                            <span id="current-time" class="text-sm text-gray-400">00:00</span>
                            <span class="mx-2 text-gray-500">/</span>
                            <span id="total-time" class="text-sm text-gray-400">00:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <button id="volume-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                            <i class="fa fa-volume-up"></i>
                        </button>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.7" 
                               class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <div class="flex items-center">
                        <button id="tempo-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                            <i class="fa fa-tachometer"></i>
                        </button>
                        <input type="range" id="tempo-slider" min="0.5" max="2" step="0.1" value="1" 
                               class="w-24 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <span id="tempo-value" class="ml-2 text-sm">1.0x</span>
                    </div>
                </div>
            </div>
            
            <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-primary w-0 transition-all duration-150"></div>
            </div>
        </section>

        <!-- 钢琴瀑布流区域 -->
        <section class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-xl mb-8 transition-all hover:shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">钢琴瀑布流</h2>
                <div class="flex space-x-2">
                    <button id="zoom-in-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <i class="fa fa-search-plus"></i>
                    </button>
                    <button id="zoom-out-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <i class="fa fa-search-minus"></i>
                    </button>
                    <button id="reset-zoom-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
            </div>
            
            <div class="relative h-[400px] mb-4 overflow-hidden border border-gray-700 rounded-lg" id="piano-roll-container">
                <div id="piano-roll" class="absolute w-full h-full">
                    <!-- 音符轨道将在这里动态生成 -->
                </div>
                <div class="absolute top-0 left-0 right-0 h-1 bg-primary/30 z-10"></div>
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-primary/30 z-10"></div>
                <div class="absolute inset-0 flex items-center justify-center" id="empty-piano-roll">
                    <div class="text-center">
                        <i class="fa fa-music text-5xl text-gray-600 mb-4"></i>
                        <p class="text-gray-500">上传MIDI文件开始播放</p>
                    </div>
                </div>
            </div>
            
            <!-- 滚动指示器 -->
            <div class="flex justify-center space-x-2 mb-4">
                <div class="scroll-indicator w-2 h-2 rounded-full bg-primary/50"></div>
                <div class="scroll-indicator w-2 h-2 rounded-full bg-primary/50" style="animation-delay: 0.2s"></div>
                <div class="scroll-indicator w-2 h-2 rounded-full bg-primary/50" style="animation-delay: 0.4s"></div>
            </div>
            
            <!-- 钢琴键盘 -->
            <div class="keyboard-container relative bg-gray-900 rounded-lg p-2 overflow-x-auto">
                <div id="keyboard" class="flex min-w-max"></div>
            </div>
        </section>

        <!-- 音轨选择区域 -->
        <section class="bg-gray-800/50 backdrop-blur-sm rounded-xl p-6 shadow-xl transition-all hover:shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">音轨选择</h2>
                <button id="toggle-all-tracks" class="text-sm text-primary hover:underline">
                    全部选择/取消
                </button>
            </div>
            
            <div id="tracks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-gray-700/30 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-primary/20 rounded flex items-center justify-center mr-3">
                            <i class="fa fa-music text-primary"></i>
                        </div>
                        <div>
                            <p class="font-medium">暂无音轨</p>
                            <p class="text-sm text-gray-400">上传MIDI文件后显示</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-dark/80 backdrop-blur-md mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>MIDI钢琴瀑布流播放器 &copy; 2025</p>
            <p class="mt-2">使用 HTML, JavaScript 和 Tailwind CSS 构建</p>
        </div>
    </footer>

    <!-- 信息模态框 -->
    <div id="info-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">关于MIDI钢琴瀑布流播放器</h3>
                <button id="close-modal" class="text-gray-400 hover:text-white">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="text-gray-300 space-y-4">
                <p>本应用程序允许您上传MIDI文件，并以钢琴瀑布流的形式播放它们。</p>
                <p>使用方法：</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>点击上传区域选择或拖放MIDI文件</li>
                    <li>上传后，您可以看到文件信息和可用音轨</li>
                    <li>选择要播放的音轨</li>
                    <li>点击播放按钮开始播放</li>
                    <li>使用控制栏调整音量、播放速度等</li>
                </ol>
                <p class="mt-4">音符会从顶部向下流动，当它们到达底部时，对应的钢琴键会被按下并发出声音。</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const fileInput = document.getElementById('midi-upload');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const trackCount = document.getElementById('track-count');
            const duration = document.getElementById('duration');
            const fileInfo = document.getElementById('file-info');
            const noFileInfo = document.getElementById('no-file-info');
            const playBtn = document.getElementById('play-btn');
            const rewindBtn = document.getElementById('rewind-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const fastForwardBtn = document.getElementById('fast-forward-btn');
            const currentTime = document.getElementById('current-time');
            const totalTime = document.getElementById('total-time');
            const progressBar = document.getElementById('progress-bar');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeBtn = document.getElementById('volume-btn');
            const tempoSlider = document.getElementById('tempo-slider');
            const tempoValue = document.getElementById('tempo-value');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const resetZoomBtn = document.getElementById('reset-zoom-btn');
            const pianoRoll = document.getElementById('piano-roll');
            const emptyPianoRoll = document.getElementById('empty-piano-roll');
            const keyboard = document.getElementById('keyboard');
            const tracksContainer = document.getElementById('tracks-container');
            const toggleAllTracks = document.getElementById('toggle-all-tracks');
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const closeModal = document.getElementById('close-modal');
            const themeToggle = document.getElementById('theme-toggle');
            
            // 应用状态
            let midiFile = null;
            let isPlaying = false;
            let currentPosition = 0;
            let tempo = 1.0;
            let zoom = 1.0;
            let activeTracks = [];
            let synth = null;
            let transport = null;
            let pianoRollHeight = 400; // 钢琴瀑布流区域高度
            let noteSpeed = 200; // 音符下落速度 (像素/秒)
            let notes = [];
            let pianoKeys = [];
            let scheduledNotes = [];
            let audioContext = null;
            
            // 初始化
            init();
            
            function init() {
                // 创建合成器
                setupSynth();
                
                // 创建钢琴键盘
                createPianoKeyboard();
                
                // 绑定事件监听器
                bindEventListeners();
                
                // 初始化主题
                initTheme();
            }
            
            function initTheme() {
                // 检查本地存储中的主题偏好
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.documentElement.classList.add('light');
                    themeToggle.innerHTML = '<i class="fa fa-sun-o text-lg"></i>';
                }
            }
            
            function setupSynth() {
                // 创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 创建合成器
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: {
                        type: 'sine'
                    },
                    envelope: {
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0.8,
                        release: 1
                    }
                }).toDestination();
                
                // 设置音量
                synth.volume.value = Tone.gainToDb(volumeSlider.value);
                
                // 创建Transport
                transport = Tone.Transport;
                transport.bpm.value = 120; // 默认BPM
            }
            
            function createPianoKeyboard() {
                // 创建88键钢琴键盘 (A0-C8)
                const WHITE_KEYS = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const BLACK_KEYS = ['C#', 'D#', '', 'F#', 'G#', 'A#', ''];
                const OCTAVES = 8;
                
                // 清除现有键盘
                keyboard.innerHTML = '';
                
                let keyCount = 0;
                let whiteKeyCount = 0;
                
                // 创建键盘容器
                const keyboardContainer = document.createElement('div');
                keyboardContainer.className = 'relative';
                
                // 创建白键
                const whiteKeysContainer = document.createElement('div');
                whiteKeysContainer.className = 'flex';
                
                // 创建黑键
                const blackKeysContainer = document.createElement('div');
                blackKeysContainer.className = 'absolute top-0 left-0 right-0 flex justify-between px-[11px]';
                blackKeysContainer.style.marginLeft = '-7px';
                
                // 生成88个键 (A0到C8)
                for (let octave = 0; octave < OCTAVES; octave++) {
                    for (let i = 0; i < 7; i++) {
                        const note = WHITE_KEYS[i] + octave;
                        const key = document.createElement('div');
                        key.className = 'piano-key white-key relative flex items-end justify-center h-32 w-10 border border-gray-700 rounded-b-md cursor-pointer transition-all';
                        key.dataset.note = note;
                        key.dataset.midi = 21 + keyCount; // MIDI编号 (A0=21)
                        key.innerHTML = `<span class="text-xs text-gray-500 mb-2">${note}</span>`;
                        
                        whiteKeysContainer.appendChild(key);
                        pianoKeys.push(key);
                        
                        // 如果对应的黑键存在，则创建黑键
                        if (BLACK_KEYS[i]) {
                            const blackNote = BLACK_KEYS[i] + octave;
                            const blackKey = document.createElement('div');
                            blackKey.className = 'piano-key black-key absolute h-20 w-6 bg-gray-900 rounded-b-md cursor-pointer transition-all -ml-3 z-10';
                            blackKey.dataset.note = blackNote;
                            blackKey.dataset.midi = 21 + keyCount + 1; // MIDI编号
                            blackKey.innerHTML = `<span class="text-xs text-gray-400 absolute bottom-2 left-1/2 transform -translate-x-1/2">${blackNote}</span>`;
                            
                            blackKeysContainer.appendChild(blackKey);
                            pianoKeys.push(blackKey);
                        }
                        
                        keyCount++;
                        whiteKeyCount++;
                        
                        // 每个八度结束后，添加适当的间距
                        if (i === 6 && octave < OCTAVES - 1) {
                            const spacer = document.createElement('div');
                            spacer.className = 'w-0.5';
                            whiteKeysContainer.appendChild(spacer);
                            whiteKeyCount++;
                        }
                    }
                }
                
                keyboardContainer.appendChild(whiteKeysContainer);
                keyboardContainer.appendChild(blackKeysContainer);
                keyboard.appendChild(keyboardContainer);
                
                // 调整键盘宽度
                const keyboardWidth = whiteKeyCount * 10 + (whiteKeyCount - 1) * 0.5; // 10px宽 + 0.5px间距
                keyboardContainer.style.width = `${keyboardWidth}px`;
            }
            
            function bindEventListeners() {
                // 文件上传
                fileInput.addEventListener('change', handleFileUpload);
                
                // 拖放上传
                const dropArea = document.querySelector('label[for="midi-upload"]');
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.classList.add('border-primary');
                    dropArea.classList.add('bg-gray-700');
                }
                
                function unhighlight() {
                    dropArea.classList.remove('border-primary');
                    dropArea.classList.remove('bg-gray-700');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length) {
                        const file = files[0];
                        if (file.type === 'audio/midi' || file.name.endsWith('.mid')) {
                            fileInput.files = files;
                            handleFileUpload();
                        } else {
                            alert('请上传MIDI文件 (.mid)');
                        }
                    }
                }
                
                // 播放控制
                playBtn.addEventListener('click', togglePlay);
                rewindBtn.addEventListener('click', rewind);
                prevBtn.addEventListener('click', prevSection);
                nextBtn.addEventListener('click', nextSection);
                fastForwardBtn.addEventListener('click', fastForward);
                
                // 音量控制
                volumeSlider.addEventListener('input', adjustVolume);
                volumeBtn.addEventListener('click', toggleMute);
                
                // 速度控制
                tempoSlider.addEventListener('input', adjustTempo);
                
                // 缩放控制
                zoomInBtn.addEventListener('click', zoomIn);
                zoomOutBtn.addEventListener('click', zoomOut);
                resetZoomBtn.addEventListener('click', resetZoom);
                
                // 轨道选择
                toggleAllTracks.addEventListener('click', toggleAllTracksHandler);
                
                // 模态框控制
                infoButton.addEventListener('click', () => infoModal.classList.remove('hidden'));
                closeModal.addEventListener('click', () => infoModal.classList.add('hidden'));
                infoModal.addEventListener('click', (e) => {
                    if (e.target === infoModal) {
                        infoModal.classList.add('hidden');
                    }
                });
                
                // 主题切换
                themeToggle.addEventListener('click', toggleTheme);
                
                // 键盘事件
                document.addEventListener('keydown', handleKeyPress);
                document.addEventListener('keyup', handleKeyRelease);
                
                // 窗口大小变化时重新计算布局
                window.addEventListener('resize', updatePianoRollDimensions);
            }
            
            function toggleTheme() {
                const isDark = document.documentElement.classList.toggle('light');
                themeToggle.innerHTML = isDark ? '<i class="fa fa-sun-o text-lg"></i>' : '<i class="fa fa-moon-o text-lg"></i>';
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
            }
            
            function handleFileUpload() {
                const file = fileInput.files[0];
                if (!file) return;
                
                if (file.type !== 'audio/midi' && !file.name.endsWith('.mid')) {
                    alert('请上传MIDI文件 (.mid)');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // 解析MIDI文件
                        midiFile = new MidiFile(e.target.result);
                        
                        // 更新文件信息
                        updateFileInfo(file);
                        
                        // 解析MIDI数据并生成音符
                        parseMidiData();
                        
                        // 清空钢琴瀑布流区域并显示音符
                        renderPianoRoll();
                        
                        // 生成音轨选择器
                        generateTrackSelectors();
                        
                        // 更新总时长
                        updateTotalTime();
                        
                        // 重置播放状态
                        resetPlayState();
                        
                    } catch (error) {
                        console.error('解析MIDI文件时出错:', error);
                        alert('无法解析MIDI文件，请尝试其他文件。');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function updateFileInfo(file) {
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                if (midiFile) {
                    trackCount.textContent = midiFile.tracks.length;
                    const durationInSeconds = midiFile.header.totalTimeSeconds;
                    duration.textContent = formatTime(durationInSeconds);
                    totalTime.textContent = formatTime(durationInSeconds);
                    
                    fileInfo.classList.remove('hidden');
                    noFileInfo.classList.add('hidden');
                    emptyPianoRoll.classList.add('hidden');
                }
            }
            
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            
            function parseMidiData() {
                if (!midiFile) return;
                
                // 清空现有音符数据
                notes = [];
                
                // 获取MIDI文件中的所有音符
                const ticksPerBeat = midiFile.header.ticksPerBeat;
                const totalTicks = midiFile.header.totalTime;
                
                // 计算每个音符的位置和持续时间
                midiFile.tracks.forEach((track, trackIndex) => {
                    let currentTime = 0;
                    let currentNotes = {};
                    
                    track.forEach(event => {
                        currentTime += event.deltaTime;
                        
                        if (event.type === 'meta' && event.subtype === 'setTempo') {
                            // 更新速度
                            const tempo = event.microsecondsPerBeat;
                            transport.bpm.value = 60000000 / tempo;
                        }
                        
                        if (event.type === 'channel' && event.subtype === 'noteOn' && event.velocity > 0) {
                            // 记录音符开始
                            const note = {
                                track: trackIndex,
                                midi: event.noteNumber,
                                noteName: getNoteName(event.noteNumber),
                                startTime: currentTime,
                                velocity: event.velocity / 127,
                                active: false
                            };
                            currentNotes[event.noteNumber] = note;
                        }
                        
                        if (event.type === 'channel' && (event.subtype === 'noteOff' || (event.subtype === 'noteOn' && event.velocity === 0))) {
                            // 记录音符结束
                            const note = currentNotes[event.noteNumber];
                            if (note) {
                                note.duration = currentTime - note.startTime;
                                notes.push(note);
                                delete currentNotes[event.noteNumber];
                            }
                        }
                    });
                });
                
                // 按开始时间排序音符
                notes.sort((a, b) => a.startTime - b.startTime);
            }
            
            function getNoteName(midiNumber) {
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const octave = Math.floor(midiNumber / 12) - 1;
                const noteIndex = midiNumber % 12;
                return noteNames[noteIndex] + octave;
            }
            
            function renderPianoRoll() {
                if (!midiFile || notes.length === 0) return;
                
                // 清空现有音符
                pianoRoll.innerHTML = '';
                
                // 创建轨道
                const ticksPerBeat = midiFile.header.ticksPerBeat;
                const totalBeats = midiFile.header.totalTime / ticksPerBeat;
                
                // 计算音符的高度和速度
                const pixelsPerTick = 0.1 * zoom; // 每个tick对应的像素数
                noteSpeed = 200 * zoom; // 音符下落速度
                
                // 创建音符
                notes.forEach(note => {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'note';
                    noteElement.dataset.midi = note.midi;
                    noteElement.dataset.track = note.track;
                    
                    // 计算音符在键盘上的位置
                    const keyIndex = note.midi - 21; // A0=21
                    const keyElement = pianoKeys[keyIndex];
                    
                    if (keyElement) {
                        // 获取键的位置和宽度
                        const keyRect = keyElement.getBoundingClientRect();
                        const pianoRollRect = pianoRoll.getBoundingClientRect();
                        
                        // 设置音符的位置和尺寸
                        const noteWidth = keyRect.width;
                        const noteLeft = keyRect.left - pianoRollRect.left;
                        const noteHeight = note.duration * pixelsPerTick;
                        
                        // 设置音符样式
                        noteElement.style.width = `${noteWidth}px`;
                        noteElement.style.height = `${Math.max(3, noteHeight)}px`;
                        noteElement.style.left = `${noteLeft}px`;
                        noteElement.style.bottom = `-${noteHeight}px`; // 初始位置在可视区域外
                        
                        // 根据轨道设置不同颜色
                        const trackColors = [
                            'bg-primary', 'bg-secondary', 'bg-amber-500', 'bg-purple-500',
                            'bg-pink-500', 'bg-emerald-500', 'bg-cyan-500', 'bg-orange-500'
                        ];
                        const colorIndex = note.track % trackColors.length;
                        noteElement.classList.add(trackColors[colorIndex]);
                        
                        // 存储音符元素的引用
                        note.element = noteElement;
                        
                        // 添加到钢琴瀑布流区域
                        pianoRoll.appendChild(noteElement);
                    }
                });
            }
            
            function generateTrackSelectors() {
                if (!midiFile) return;
                
                // 清空现有轨道选择器
                tracksContainer.innerHTML = '';
                
                // 如果没有轨道，显示提示
                if (midiFile.tracks.length === 0) {
                    const noTracksElement = document.createElement('div');
                    noTracksElement.className = 'bg-gray-700/30 rounded-lg p-4 flex items-center justify-between';
                    noTracksElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-primary/20 rounded flex items-center justify-center mr-3">
                                <i class="fa fa-music text-primary"></i>
                            </div>
                            <div>
                                <p class="font-medium">无音轨</p>
                                <p class="text-sm text-gray-400">MIDI文件不包含任何音轨</p>
                            </div>
                        </div>
                    `;
                    tracksContainer.appendChild(noTracksElement);
                    return;
                }
                
                // 为每个轨道创建选择器
                midiFile.tracks.forEach((track, index) => {
                    const trackElement = document.createElement('div');
                    trackElement.className = 'bg-gray-700/30 rounded-lg p-4 flex items-center justify-between hover:bg-gray-700/50 transition-colors';
                    
                    // 尝试获取轨道名称
                    let trackName = `轨道 ${index + 1}`;
                    const trackNameEvent = track.find(event => event.type === 'meta' && event.subtype === 'trackName');
                    if (trackNameEvent) {
                        trackName = trackNameEvent.text;
                    }
                    
                    // 获取轨道中的音符数量
                    const trackNotes = notes.filter(note => note.track === index);
                    const noteCount = trackNotes.length;
                    
                    // 根据轨道设置不同颜色
                    const trackColors = [
                        'bg-primary/20', 'bg-secondary/20', 'bg-amber-500/20', 'bg-purple-500/20',
                        'bg-pink-500/20', 'bg-emerald-500/20', 'bg-cyan-500/20', 'bg-orange-500/20'
                    ];
                    const iconColors = [
                        'text-primary', 'text-secondary', 'text-amber-500', 'text-purple-500',
                        'text-pink-500', 'text-emerald-500', 'text-cyan-500', 'text-orange-500'
                    ];
                    const colorIndex = index % trackColors.length;
                    
                    trackElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 ${trackColors[colorIndex]} rounded flex items-center justify-center mr-3">
                                <i class="fa fa-music ${iconColors[colorIndex]}"></i>
                            </div>
                            <div>
                                <p class="font-medium">${trackName}</p>
                                <p class="text-sm text-gray-400">${noteCount} 个音符</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" class="sr-only peer track-checkbox" data-track="${index}">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                        </label>
                    `;
                    
                    // 添加轨道选择事件
                    const checkbox = trackElement.querySelector('.track-checkbox');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            activeTracks.push(index);
                        } else {
                            activeTracks = activeTracks.filter(trackIndex => trackIndex !== index);
                        }
                        
                        // 如果正在播放，重新安排音符
                        if (isPlaying) {
                            rescheduleNotes();
                        }
                    });
                    
                    tracksContainer.appendChild(trackElement);
                });
                
                // 默认选择所有轨道
                activeTracks = Array.from({length: midiFile.tracks.length}, (_, i) => i);
                document.querySelectorAll('.track-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
            }
            
            function toggleAllTracksHandler() {
                const checkboxes = document.querySelectorAll('.track-checkbox');
                const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                
                if (allChecked) {
                    // 取消所有选择
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    activeTracks = [];
                } else {
                    // 选择所有轨道
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    activeTracks = Array.from({length: checkboxes.length}, (_, i) => i);
                }
                
                // 如果正在播放，重新安排音符
                if (isPlaying) {
                    rescheduleNotes();
                }
            }
            
            function togglePlay() {
                if (!midiFile || notes.length === 0) return;
                
                if (isPlaying) {
                    // 暂停播放
                    transport.pause();
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fa fa-play text-xl"></i>';
                    document.querySelectorAll('.piano-key.active').forEach(key => {
                        key.classList.remove('active');
                    });
                } else {
                    // 开始播放
                    if (transport.state === 'stopped') {
                        scheduleNotes();
                    }
                    
                    // 如果是第一次播放，启动音频上下文
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    transport.start();
                    isPlaying = true;
                    playBtn.innerHTML = '<i class="fa fa-pause text-xl"></i>';
                    
                    // 开始动画循环
                    requestAnimationFrame(updateAnimation);
                }
            }
            
            function resetPlayState() {
                // 停止播放
                if (isPlaying) {
                    transport.stop();
                    isPlaying = false;
                    playBtn.innerHTML = '<i class="fa fa-play text-xl"></i>';
                }
                
                // 重置当前位置
                currentPosition = 0;
                updateProgressBar();
                
                // 重置所有音符位置
                notes.forEach(note => {
                    if (note.element) {
                        note.element.style.bottom = `-${note.element.offsetHeight}px`;
                        note.active = false;
                    }
                });
                
                // 释放所有钢琴键
                document.querySelectorAll('.piano-key.active').forEach(key => {
                    key.classList.remove('active');
                });
            }
            
            function rewind() {
                if (!midiFile) return;
                
                // 回到开始位置
                currentPosition = 0;
                transport.position = '0:0:0';
                updateProgressBar();
                
                // 重置所有音符位置
                notes.forEach(note => {
                    if (note.element) {
                        note.element.style.bottom = `-${note.element.offsetHeight}px`;
                        note.active = false;
                    }
                });
                
                // 释放所有钢琴键
                document.querySelectorAll('.piano-key.active').forEach(key => {
                    key.classList.remove('active');
                });
            }
            
            function prevSection() {
                if (!midiFile) return;
                
                // 向前移动10秒
                currentPosition = Math.max(0, currentPosition - 10);
                transport.position = currentPosition;
                updateProgressBar();
                
                // 更新音符位置
                updateNotePositions();
            }
            
            function nextSection() {
                if (!midiFile) return;
                
                const totalDuration = midiFile.header.totalTimeSeconds;
                
                // 向后移动10秒
                currentPosition = Math.min(totalDuration, currentPosition + 10);
                transport.position = currentPosition;
                updateProgressBar();
                
                // 更新音符位置
                updateNotePositions();
            }
            
            function fastForward() {
                if (!midiFile) return;
                
                const totalDuration = midiFile.header.totalTimeSeconds;
                
                // 前进到50%位置
                currentPosition = totalDuration * 0.5;
                transport.position = currentPosition;
                updateProgressBar();
                
                // 更新音符位置
                updateNotePositions();
            }
            
            function updateProgressBar() {
                if (!midiFile) return;
                
                const totalDuration = midiFile.header.totalTimeSeconds;
                const progressPercentage = (currentPosition / totalDuration) * 100;
                
                progressBar.style.width = `${progressPercentage}%`;
                currentTime.textContent = formatTime(currentPosition);
            }
            
            function updateTotalTime() {
                if (!midiFile) return;
                
                const totalDuration = midiFile.header.totalTimeSeconds;
                totalTime.textContent = formatTime(totalDuration);
            }
            
            function adjustVolume() {
                const volume = volumeSlider.value;
                synth.volume.value = Tone.gainToDb(volume);
                
                // 更新音量图标
                if (volume > 0.7) {
                    volumeBtn.innerHTML = '<i class="fa fa-volume-up"></i>';
                } else if (volume > 0) {
                    volumeBtn.innerHTML = '<i class="fa fa-volume-down"></i>';
                } else {
                    volumeBtn.innerHTML = '<i class="fa fa-volume-off"></i>';
                }
            }
            
            function toggleMute() {
                if (volumeSlider.value > 0) {
                    volumeSlider.dataset.lastVolume = volumeSlider.value;
                    volumeSlider.value = 0;
                } else {
                    const lastVolume = volumeSlider.dataset.lastVolume || 0.7;
                    volumeSlider.value = lastVolume;
                }
                
                adjustVolume();
            }
            
            function adjustTempo() {
                tempo = parseFloat(tempoSlider.value);
                tempoValue.textContent = `${tempo.toFixed(1)}x`;
                
                // 更新Transport速度
                transport.timeSignature = [4, 4];
                transport.bpm.value = 120 * tempo;
                
                // 如果正在播放，重新安排音符
                if (isPlaying) {
                    rescheduleNotes();
                }
            }
            
            function zoomIn() {
                zoom = Math.min(zoom * 1.2, 5.0);
                renderPianoRoll();
            }
            
            function zoomOut() {
                zoom = Math.max(zoom / 1.2, 0.5);
                renderPianoRoll();
            }
            
            function resetZoom() {
                zoom = 1.0;
                renderPianoRoll();
            }
            
            function updatePianoRollDimensions() {
                // 重新渲染钢琴瀑布流以适应新尺寸
                if (midiFile && notes.length > 0) {
                    renderPianoRoll();
                }
            }
            
            function scheduleNotes() {
                // 清除之前的计划
                transport.cancel();
                scheduledNotes = [];
                
                if (!midiFile || notes.length === 0) return;
                
                const ticksPerBeat = midiFile.header.ticksPerBeat;
                const secondsPerTick = 60 / (transport.bpm.value * ticksPerBeat);
                
                // 为每个音符安排播放时间
                notes.forEach(note => {
                    // 只安排活动轨道中的音符
                    if (!activeTracks.includes(note.track)) return;
                    
                    const startTime = note.startTime * secondsPerTick;
                    const duration = note.duration * secondsPerTick;
                    
                    // 安排音符播放
                    const scheduledId = transport.schedule(time => {
                        // 按下钢琴键
                        pressKey(note.midi);
                        
                        // 安排释放钢琴键
                        transport.schedule(releaseTime => {
                            releaseKey(note.midi);
                        }, time + duration);
                        
                        // 播放音符
                        synth.triggerAttackRelease(note.noteName, duration, time, note.velocity);
                        
                    }, startTime);
                    
                    scheduledNotes.push({
                        note,
                        scheduledId
                    });
                });
            }
            
            function rescheduleNotes() {
                // 停止当前播放
                const wasPlaying = isPlaying;
                if (wasPlaying) {
                    transport.pause();
                }
                
                // 重置所有音符状态
                notes.forEach(note => {
                    note.active = false;
                });
                
                // 释放所有钢琴键
                document.querySelectorAll('.piano-key.active').forEach(key => {
                    key.classList.remove('active');
                });
                
                // 重新安排音符
                scheduleNotes();
                
                // 恢复播放状态
                if (wasPlaying) {
                    transport.start();
                }
            }
            
            function pressKey(midiNumber) {
                const keyIndex = midiNumber - 21;
                const keyElement = pianoKeys[keyIndex];
                
                if (keyElement && !keyElement.classList.contains('active')) {
                    // 激活白键或黑键
                    if (keyElement.classList.contains('white-key')) {
                        keyElement.classList.add('active', 'bg-primary/30', 'border-primary');
                    } else {
                        keyElement.classList.add('active', 'bg-primary');
                    }
                }
            }
            
            function releaseKey(midiNumber) {
                const keyIndex = midiNumber - 21;
                const keyElement = pianoKeys[keyIndex];
                
                if (keyElement && keyElement.classList.contains('active')) {
                    // 释放白键或黑键
                    if (keyElement.classList.contains('white-key')) {
                        keyElement.classList.remove('active', 'bg-primary/30', 'border-primary');
                    } else {
                        keyElement.classList.remove('active', 'bg-primary');
                    }
                }
            }
            
            function updateAnimation(timestamp) {
                if (!isPlaying) return;
                
                // 更新当前播放位置
                currentPosition = transport.seconds;
                updateProgressBar();
                
                // 更新音符位置
                updateNotePositions();
                
                // 继续动画循环
                requestAnimationFrame(updateAnimation);
            }
            
            function updateNotePositions() {
                if (!midiFile || notes.length === 0) return;
                
                const ticksPerBeat = midiFile.header.ticksPerBeat;
                const secondsPerTick = 60 / (transport.bpm.value * ticksPerBeat);
                
                notes.forEach(note => {
                    if (!note.element) return;
                    
                    // 只处理活动轨道中的音符
                    if (!activeTracks.includes(note.track)) {
                        note.element.style.bottom = `-${note.element.offsetHeight}px`;
                        if (note.active) {
                            releaseKey(note.midi);
                            note.active = false;
                        }
                        return;
                    }
                    
                    const startTime = note.startTime * secondsPerTick;
                    const endTime = (note.startTime + note.duration) * secondsPerTick;
                    const noteHeight = note.element.offsetHeight;
                    
                    // 计算音符应该在的位置
                    if (currentPosition >= startTime && currentPosition <= endTime) {
                        // 音符在可视区域内
                        const progress = (currentPosition - startTime) / (endTime - startTime);
                        const position = pianoRollHeight - (progress * (pianoRollHeight + noteHeight));
                        note.element.style.bottom = `${position}px`;
                        
                        // 如果音符到达底部，按下键
                        if (position <= 0 && !note.active) {
                            pressKey(note.midi);
                            note.active = true;
                        }
                    } else if (currentPosition < startTime) {
                        // 音符尚未出现
                        note.element.style.bottom = `-${noteHeight}px`;
                        if (note.active) {
                            releaseKey(note.midi);
                            note.active = false;
                        }
                    } else {
                        // 音符已过
                        note.element.style.bottom = `${pianoRollHeight}px`;
                        if (note.active) {
                            releaseKey(note.midi);
                            note.active = false;
                        }
                    }
                });
            }
            
            // 键盘事件处理
            function handleKeyPress(e) {
                // 只处理没有修饰键的按键
                if (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey) return;
                
                // 简单的键盘映射 (仅用于演示)
                const keyMap = {
                    'a': 60, // C4 (middle C)
                    's': 62, // D4
                    'd': 64, // E4
                    'f': 65, // F4
                    'g': 67, // G4
                    'h': 69, // A4
                    'j': 71, // B4
                    'k': 72, // C5
                    'l': 74, // D5
                    ';': 76, // E5
                    '\'': 77, // F5
                    
                    'w': 61, // C#4
                    'e': 63, // D#4
                    't': 66, // F#4
                    'y': 68, // G#4
                    'u': 70, // A#4
                    'o': 73, // C#5
                    'p': 75  // D#5
                };
                
                const midiNumber = keyMap[e.key];
                if (midiNumber) {
                    e.preventDefault();
                    pressKey(midiNumber);
                    
                    // 播放音符
                    const noteName = getNoteName(midiNumber);
                    synth.triggerAttack(noteName, Tone.now(), 0.8);
                }
            }
            
            function handleKeyRelease(e) {
                // 简单的键盘映射 (仅用于演示)
                const keyMap = {
                    'a': 60, // C4 (middle C)
                    's': 62, // D4
                    'd': 64, // E4
                    'f': 65, // F4
                    'g': 67, // G4
                    'h': 69, // A4
                    'j': 71, // B4
                    'k': 72, // C5
                    'l': 74, // D5
                    ';': 76, // E5
                    '\'': 77, // F5
                    
                    'w': 61, // C#4
                    'e': 63, // D#4
                    't': 66, // F#4
                    'y': 68, // G#4
                    'u': 70, // A#4
                    'o': 73, // C#5
                    'p': 75  // D#5
                };
                
                const midiNumber = keyMap[e.key];
                if (midiNumber) {
                    e.preventDefault();
                    releaseKey(midiNumber);
                    
                    // 停止音符
                    const noteName = getNoteName(midiNumber);
                    synth.triggerRelease(noteName, Tone.now());
                }
            }
        });
    </script>
</body>
</html>
    
